{% extends "base.html" %}
{% block content %}
<div class="container page-section">
    <h1 class="page-title">Randevunuzu Oluşturun</h1>
    <div class="form-container">
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.name.label(class="form-label") }}
                {{ form.name(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.email.label(class="form-label") }}
                {{ form.email(class="form-control", placeholder="For appointment confirmation") }}
            </div>
            <div class="form-group">
                {{ form.phone.label(class="form-label") }}
                {{ form.phone(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.service.label(class="form-label") }}
                {{ form.service(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.date.label(class="form-label") }}
                {{ form.date(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.time.label(class="form-label") }}
                {{ form.time(class="form-control") }} <small id="time-loader" style="display: none;">Finding available times...</small>
            </div>
            <div class="form-group">
                {{ form.message.label(class="form-label") }}
                {{ form.message(class="form-control", rows=5) }}
            </div>
            <div class="form-group">
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
</div>

{% block scripts %}
<script src="https://unpkg.com/imask"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- GÜNCELLENMİŞ MÜSAİT SAAT KONTROL SCRİPTİ ---
    const serviceSelect = document.getElementById('service');
    const dateInput = document.getElementById('date');
    const timeSelect = document.getElementById('time'); // Artık <select> listesini seçiyoruz
    const timeLoader = document.getElementById('time-loader');

    // Müsait saatleri getiren fonksiyon
    function fetchAvailableSlots() {
        const serviceId = serviceSelect.value;
        const selectedDate = dateInput.value;

        if (!serviceId || !selectedDate) {
            timeSelect.innerHTML = '<option value="">Lütfen önce hizmet ve tarih seçin</option>';
            return;
        }

        timeSelect.innerHTML = ''; // Eski seçenekleri temizle
        timeLoader.style.display = 'block';
        timeSelect.disabled = true; // Yüklenirken listeyi kilitle

        fetch(`/api/available_slots/${serviceId}/${selectedDate}`)
            .then(response => response.json())
            .then(slots => {
                timeLoader.style.display = 'none';
                timeSelect.disabled = false; // Kilidi aç

                if (slots.length > 0) {
                    timeSelect.innerHTML = '<option value="">Bir saat seçin</option>';
                    slots.forEach(slot => {
                        // Buton yerine <option> oluştur
                        const option = document.createElement('option');
                        option.value = slot;
                        option.textContent = slot;
                        timeSelect.appendChild(option);
                    });
                } else {
                    timeSelect.innerHTML = '<option value="">Bu tarih için müsait saat bulunmamaktadır.</option>';
                }
            })
            .catch(error => {
                console.error('Error fetching slots:', error);
                timeLoader.style.display = 'none';
                timeSelect.disabled = false;
                timeSelect.innerHTML = '<option value="">Saatler yüklenirken hata oluştu.</option>';
            });
    }

    // Hem hizmet hem de tarih değiştiğinde fonksiyonu tetikle
    serviceSelect.addEventListener('change', fetchAvailableSlots);
    dateInput.addEventListener('change', fetchAvailableSlots);

    // BUTON TIKLAMA OLAYI SİLİNDİ (artık gerekli değil)

    // --- TELEFON MASKESİ KODU (DEĞİŞMEDİ) ---
    const phoneElement = document.getElementById('phone');
    if (phoneElement) {
        // ... (mevcut telefon maskesi kodunuz burada) ...
        const phoneMask = IMask(phoneElement, {
            mask: '+{90} (000) 000 00 00',
            lazy: false, 
            prepare: function (str) {
                if (str.startsWith('+9') && !str.startsWith('+90')) {
                    return '+90';
                }
                return str;
            }
        });
    }
});
</script>
{% endblock %}

{% endblock %}